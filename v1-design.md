ğŸ˜„ V1 ğŸ˜„

# 1. åŸºæœ¬æµç¨‹

æ•°æ®åº“çš„åŸºæœ¬æ‰§è¡Œæµç¨‹ï¼š

1. è¾“å‡ºå‘½ä»¤æç¤ºç¬¦

   ```go
   // main.go
   fmt.Print("MylDB > ")
   ```

2. è¯»å–ç”¨æˆ·è¾“å…¥

3. åˆ¤æ–­æ˜¯å¦è¦æ‰§è¡Œå…ƒå‘½ä»¤ï¼ˆä»¥ `.` å­—ç¬¦å¼€å¤´çš„å‘½ä»¤ï¼‰

   ```go
   // main.go
   if cmd[0] == '.' {
       ...
   }
   ```

4. å‡†å¤‡ SQL è¯­å¥
5. æ‰§è¡Œ SQL è¯­å¥

# 2. å­˜å‚¨ç»“æ„

## 2.1 è¡¨çš„å®šä¹‰

æ•°æ®åº“ä¸­åªæœ‰ä¸€å¼  `users` è¡¨ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š

```
+------------+------------+----------+
| field name | MySQL type |  Go type |
+------------+------------+----------+
|  id (PK)   |    int     |   int32  |
+------------+------------+----------+
|  username  |  char(16)  | [16]byte |
+------------+------------+----------+
|    email   |  char(64)  | [64]byte |
+------------+------------+----------+
```

## 2.2 è¡Œ

ä¸€ä¸ª `user` å¯¹åº”è¡¨ä¸­çš„ä¸€è¡Œæ•°æ®ï¼Œä½¿ç”¨ `Row` ç»“æ„å­˜å‚¨ï¼š

```go
// storage_structs.go
type Row struct {
	id       int32
	username [USERNAME_SIZE]byte
	email    [EMAIL_SIZE]byte
}
```

ä¸€ä¸ª `Row` ç»“æ„ä½“åç»­ä¼šè¢«åºåˆ—åŒ–ä¸ºä¸€ä¸ªå­—èŠ‚æ•°ç»„æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œåœ¨ `storage_structs.go` æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€äº›å¸¸é‡è¡¨ç¤ºç»“æ„ä½“æˆå‘˜çš„å¤§å°å’Œåç§»é‡ï¼Œå®ƒä»¬ç”¨äºåç»­çš„ååºåˆ—åŒ–ã€‚ä¸€ä¸ª `Row` ç»“æ„ä½“çš„å­˜å‚¨å¸ƒå±€å¦‚ä¸‹ï¼š

```
ID_OFFSET   USERNAME_OFFSET   EMAIL_OFFSET
 ^               ^                 ^
 |               |                 |
+---------------+-----------------+----------------+
|      id       |     username    |      email     |
+---------------+-----------------+----------------+
+--- ID_SIZE ---+- USERNAME_SIZE -+-- EMAIL_SIZE --+
+--------------------- ROW_SIZE -------------------+
```

## 2.3 é¡µ

ä¸€ä¸ªé¡µï¼ˆ `Page` ï¼‰æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œç”¨äºï¼ˆè¿ç»­åœ°ï¼‰å­˜å‚¨å°½å¯èƒ½å¤šçš„ï¼ˆå®Œæ•´çš„ï¼‰è¡Œä¸­çš„æ•°æ®ã€‚ä¸€ä¸ªè¡Œä¸ä¼šè¢«è·¨é¡µå­˜å‚¨ï¼Œæ‰€ä»¥é¡µå°¾éƒ¨çš„ç©ºé—´å¯èƒ½ä¼šè¢«æµªè´¹ã€‚é¡µä¸­çš„å†…å®¹åœ¨æ•°æ®åº“æ‰“å¼€æ—¶ä»ç£ç›˜æ–‡ä»¶ä¸­åŠ è½½ï¼ˆè¯»å…¥ï¼‰ã€åœ¨æ•°æ®åº“å…³é—­æ—¶æŒä¹…åŒ–ï¼ˆå†™å…¥ï¼‰åˆ°ç£ç›˜æ–‡ä»¶ã€‚

```go
// storage_structs.go
type Page struct {
	rows [PAGE_SIZE]byte
}
```

ä¸€ä¸ªé¡µçš„å­˜å‚¨å¸ƒå±€å¦‚ä¸‹ï¼š

```
 0                                                                                   PAGE_SIZE-1
 ^                                                                                        ^
 |                                                                                        |
+----+----------+-------+----+----------+-------+-----+----+------------+-------+----------+
| id | username | email | id | username | email | ... | id |  username  | email |  wasted  |
+----+----------+-------+----+----------+-------+-----+----+------------+-------+----------+
|                       |                       |     |                         |          |
+------- Row (0) -------+------- Row (1) -------+-...-+- Row (ROWS_PER_PAGE-1) -+- wasted -+
+------------------------------------------- Page -----------------------------------------+
```

## 2.4 é¡µç®¡ç†å™¨

è¡¨ä¸­æœ€å¤šå¯ä»¥åŒ…å« `TABLE_MAX_PAGES` ä¸ªé¡µï¼Œä¸€ä¸ª `Pager` ç»“æ„ç”¨äºç®¡ç†è¿™äº›é¡µã€‚ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œå¯¹è¿™äº›é¡µçš„ç®¡ç†æ˜¯ä½¿ç”¨é¡µæŒ‡é’ˆæ•°ç»„æ¥å®ç°çš„ï¼šåªæœ‰åœ¨éœ€è¦è®¿é—®æŸä¸ªé¡µä¸­çš„è¡Œæ—¶æ‰ä¼šä¸ºå®ƒåˆ†é…ç©ºé—´ï¼Œç„¶åä»ç£ç›˜ä¸­åŠ è½½é¡µä¸­çš„å†…å®¹åˆ°å†…å­˜ï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯åœ¨ `pageinfo` å‡½æ•°ä¸­ï¼ˆ2.7 èŠ‚ï¼‰å®ç°çš„ã€‚ä¸€ä¸ª `Pager` ç»“æ„åŒ…å«ä¸€ä¸ªæ‰“å¼€çš„æ•°æ®åº“æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé¡µä¸­æ•°æ®çš„åŠ è½½å’ŒæŒä¹…åŒ–æ˜¯é€šè¿‡è¯»å†™è¯¥æ–‡ä»¶å®ç°çš„ã€‚ç»“æ„ä½“ `Pager` çš„å®šä¹‰å¦‚ä¸‹ï¼š

```go
// storage_structs.go
type Pager struct {
	dbfile *os.File
	length int64
	pages  [TABLE_MAX_PAGES]*Page
}
```

ä¸€ä¸ª `Pager` çš„å‚¨å­˜å¸ƒå±€å¦‚ä¸‹ï¼š

```
             +-----------------------+
        ---> | database file in disk |
      /      +-----------------------+
     /
+---/----+--------+-----------------+-----------------+-----+---------------------------------+
| dbfile | length | ptr to Page (0) | ptr to Page (1) | ... | ptr to Page (TABLE_MAX_PAGES-1) |
+--------+--------+-----------------+-----------------+-----+---------------------------------+
|                                                                                             |
+-------------------------------------------- Pager ------------------------------------------+
```

## 2.5 è¡¨

ä¸€ä¸ª `Table` ç»“æ„ä½“è¡¨ç¤ºä¸€å¼ æ‰“å¼€çš„è¡¨ï¼Œå®ƒç”±å½“å‰è¡¨ä¸­çš„è¡Œæ•° `rowCnt` å’ŒæŒ‡å‘ `Pager` ç»“æ„ä½“çš„æŒ‡é’ˆç»„æˆï¼š

```go
// storage_structs.go
type Table struct {
	rowCnt int
	pager  *Pager
}
```

## 2.6 æ¸¸æ ‡

ç»“æ„ä½“ `Cursor` çš„ä½œç”¨ç±»ä¼¼äºä¸€ä¸ªè¿­ä»£å™¨ã€‚ä½¿ç”¨æ¸¸æ ‡å¯ä»¥ä»…é€šè¿‡è¡Œå·æ¥è®¿é—®æ•°æ®åº“ä¸­çš„ä¸€æ¡è®°å½•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ `cursorAdvance` å‡½æ•°æ¥ç§»åŠ¨æ¸¸æ ‡ä»è€Œè®¿é—®ä¸åŒçš„è¡Œã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š

```go
// storage_structs.go
type Cursor struct {
	table *Table
	rowId int
	isEnd bool
}
```

## 2.7 æ€»ç»“

æ•°æ®åº“ä¸­çš„æ¯ä¸€è¡Œæ•°æ®è¢«åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„åå†è¢«è¿ç»­å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼ˆå¤„äºä¸¤ä¸ªé¡µäº¤ç•Œå¤„çš„è¡Œå¯èƒ½æ˜¯ä¸è¿ç»­çš„ï¼‰ï¼Œè‹¥å¹²ä¸ªè¡Œåˆè¢«ç»„ç»‡æˆä¸€ä¸ªæŠ½è±¡çš„ â€œé¡µâ€ ã€‚å‡è®¾ä¸€ä¸ªé¡µä¸­èƒ½å­˜å‚¨ 48 è¡Œï¼Œé‚£ä¹ˆæ•´ä¸ªæ•°æ®åº“åœ¨ç£ç›˜ä¸Šå¤§è‡´æ˜¯è¿™æ ·å­˜å‚¨çš„ï¼š

```
+-------+-------+-----+--------+--------+--------+--------+-----+--------+--------+-----
| row 0 | row 1 | ... | row 47 | wasted | row 48 | row 49 | ... | row 95 | wasted | ...
+-------+-------+-----+--------+--------+--------+--------+-----+--------+--------+-----
|              page 0                   |                    page 1               | ...
+---------------------------------------+-----------------------------------------+-----
```

å½“é€šè¿‡è¡Œå·æ¥è®¿é—®æŸä¸€è¡Œçš„æ•°æ®æ—¶ï¼Œè¿™ä¸€è¡Œæ‰€åœ¨çš„æ•´ä¸ªé¡µéƒ½ä¼šè¢«åŠ è½½åˆ°å†…å­˜ï¼Œè¿™æ ·åœ¨åç»­è®¿é—®è¯¥è¡Œé™„è¿‘çš„è¡Œæ—¶å°±ä¸ç”¨å†è¿›è¡Œç£ç›˜ `I/O` ã€‚å› ä¸ºæ¯ä¸€ä¸ªè¡Œå·éƒ½å¯¹åº”å”¯ä¸€çš„é¡µå·å’Œé¡µåç§»é‡ï¼Œæ‰€ä»¥åœ¨é¡µä¸­çš„æ•°æ®è¢«åŠ è½½åˆ°å†…å­˜åå°±å¯ä»¥é€šè¿‡é¡µå·å’Œé¡µåç§»é‡æ¥è®¿é—®æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚å‡½æ•° `pageinfo` è´Ÿè´£åšè¿™ä¸ªè½¬æ¢ä»¥åŠåŠ è½½é¡µåˆ°å†…å­˜ï¼š

```go
// storage_structs.go
func pageinfo(cursor *Cursor) (pageId int, pageOffset int) {
	pageId = cursor.rowId / ROWS_PER_PAGE
	pageOffset = (cursor.rowId % ROWS_PER_PAGE) * ROW_SIZE
	if pageId > TABLE_MAX_PAGES-1 {
		fmt.Fprintf(os.Stderr, "page id is out of bound: %d > %d\n", pageId, TABLE_MAX_PAGES-1)
		os.Exit(1)
	}
	pager := cursor.table.pager
	if pager.pages[pageId] == nil {
		pager.pages[pageId] = &Page{}
		if _, err := pager.dbfile.Seek(int64(pageId*PAGE_SIZE), io.SeekStart); err != nil {
			fmt.Fprintf(os.Stderr, "load page error: %s\n", err.Error())
			os.Exit(1)
		}
		if _, err := pager.dbfile.Read(pager.pages[pageId].rows[:]); err != nil {
			if err == io.EOF {
				return
			}
			fmt.Fprintf(os.Stderr, "load page error: %s\n", err.Error())
			os.Exit(1)
		}
	}
	return
}
```

# 3. è¯­å¥çš„å‡†å¤‡å’Œæ‰§è¡Œ

ä¸€æ¡ SQL è¯­å¥ç”¨ä¸€ä¸ª `Stmt` ç»“æ„ä½“è¡¨ç¤ºï¼š

```go
// stmt.go
type StmtType int

type Stmt struct {
	tp  StmtType
	row Row
}
```

ç›®å‰æ”¯æŒæ’å…¥å’ŒæŸ¥è¯¢è¯­å¥ã€‚å‡†å¤‡è¯­å¥æ—¶é¦–å…ˆè¦è®¾ç½®å…¶ç±»å‹ï¼Œç„¶åå¯¹äºæ ¼å¼ä¸º `INSERT [id] [username] [email]` çš„æ’å…¥è¯­å¥ï¼Œåˆ™ä¼šå°†æˆå‘˜ `row` ä¸­å¯¹åº”çš„å­—æ®µè®¾ç½®ä¸ºå¯¹åº”çš„å€¼ï¼›å¯¹äºæ ¼å¼ä¸º `SELECT` çš„æŸ¥è¯¢è¯­å¥åˆ™ä¸åšå…¶ä»–å¤„ç†ã€‚

è¯­å¥å‡†å¤‡å¥½åå°±å¯ä»¥æ‰§è¡Œäº†ã€‚æ€»ä½“ä¸Šæ¥çœ‹ï¼Œæ’å…¥è¯­å¥å°±æ˜¯å°†ä¸€è¡Œæ•°æ®åºåˆ—åŒ–åæ·»åŠ åˆ°è¡¨æœ«å°¾ï¼š

```go
// exec.go
func execInsert(stmt *Stmt, table *Table) ExecuteResult {
	if table.rowCnt >= TABLE_MAX_ROWS {
		return EXEC_TABLE_FULL
	}
	serializeRow(&(stmt.row), tableEnd(table))
	table.rowCnt++
	return EXEC_SUCCESS
}
```

æŸ¥è¯¢è¯­å¥å°±æ˜¯éå†æ¯ä¸€è¡Œï¼Œç„¶åå°†å…¶ååºåˆ—åŒ–åå­˜å‚¨åˆ°ä¸€ä¸ª `Row` ç»“æ„ä½“ä¸­å¹¶æ‰“å°å‡ºæ¥ï¼š

```go
// exec.go
func execSelect(stmt *Stmt, table *Table) ExecuteResult {
	var row Row
	for cursor := tableStart(table); !cursor.isEnd; cursorAdvance(cursor) {
		deserializeRow(&row, cursor)
		printRow(&row)
	}
	return EXEC_SUCCESS
}
```

# 4. æ•°æ®æŒä¹…åŒ–

æ‰§è¡Œæ’å…¥è¯­å¥åï¼Œæ•°æ®éƒ½å­˜å‚¨åœ¨ä½äºå†…å­˜ä¸­ç”± `Pager` ç®¡ç†çš„å¤šä¸ª `Page` ä¸­ã€‚å½“è¾“å…¥å…ƒå‘½ä»¤ `.exit` å…³é—­æ•°æ®åº“æ—¶ï¼Œä½äºå†…å­˜ä¸­çš„æ•°æ®åº”è¯¥è¢«å†™å…¥åˆ°ç”± `Pager` ç®¡ç†çš„ `dbfile` æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥æ•°æ®çš„æŒä¹…åŒ–å°±æ˜¯å°† `Pager` ç®¡ç†çš„æ‰€æœ‰éç©ºé¡µå†™å…¥ç£ç›˜æ–‡ä»¶ï¼š

```go
// persistence.go
func flushPager(pager *Pager, pageId int, nbytes int) {
	if pager.pages[pageId] == nil {
		fmt.Fprintf(os.Stderr, "tried to flush null page\n")
		os.Exit(1)
	}
	if _, err := pager.dbfile.Seek(int64(pageId*PAGE_SIZE), io.SeekStart); err != nil {
		fmt.Fprintf(os.Stderr, "flush page error: %s\n", err.Error())
		os.Exit(1)
	}
	if _, err := pager.dbfile.Write(pager.pages[pageId].rows[:nbytes]); err != nil {
		fmt.Fprintf(os.Stderr, "flush page error: %s\n", err.Error())
		os.Exit(1)
	}
}
```





